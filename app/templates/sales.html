<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>CSV â†’ DAT Converter</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/static/sales.css" />

  </head>

  <body>
    <div class="sidebar">
      <h4 class="sidebar-header">Summary List - <br>Sales</br></h4>

      <label class="small-label">Client TIN</label>
      <input id="client_tin" class="form-control mb-2" placeholder="XXX-XXX-XXX" maxlength="11" inputmode="numeric" pattern="[0-9\-]*" />

      <label class="small-label">Name & Address</label>
      <input id="corporate_name" class="form-control mb-1" placeholder="Corporate name" />
      <input id="last_name" class="form-control mb-1" placeholder="Last name" />
      <input id="first_name" class="form-control mb-1" placeholder="First name" />
      <input id="middle_name" class="form-control mb-1" placeholder="Middle name" />
      <input id="trade_name" class="form-control mb-1" placeholder="Trade name" />
      <input id="address1" class="form-control mb-1" placeholder="Street, Barangay" />
      <input id="address2" class="form-control mb-1" placeholder="Municipality/City, Zip" />

      <label class="small-label mt-2">RDO</label>
      <input id="rdo" class="form-control mb-2" placeholder="e.g. 001" />

      <label class="small-label">Period Covered (MM/DD/YYYY)</label>
      <input id="period" class="form-control mb-3" placeholder="mm/dd/yyyy" />

      <div class="spacer"></div>

      <div class="d-grid gap-2 mt-3">
        <button id="submit-btn" class="btn btn-primary">Insert</button>
        <button id="upload-btn" class="btn btn-outline-light">Upload CSV</button>
        <input id="csv-input" type="file" accept=".csv" style="display:none" />
        <button id="clear-btn" class="btn btn-danger">Clear List</button>
      </div>

      <div class="sidebar-buttons d-flex gap-2 mt-3">
        <a href="/dashboard" class="menu-btn">Menu</a>
        <a href="/logout" class="logout-btn">Logout</a>
      </div>
    </div>

    <div class="main-content">
      <div class="card p-4 flex-grow-1">
        <h6 class="text-info mb-2">Data Preview</h6>
        <div id="user-list"></div>

        <div class="sum-box compact mt-3">
          <h6 class="text-info mb-2">Sums</h6>
          <div id="sums" class="row row-cols-2 g-1">
            <div class="sum-item"><span class="summary-label">Exempt</span><span id="exempt" class="summary-value">0.00</span></div>
            <div class="sum-item"><span class="summary-label">Zero Rated</span><span id="zero" class="summary-value">0.00</span></div>
            <div class="sum-item"><span class="summary-label">Taxable</span><span id="taxable" class="summary-value">0.00</span></div>
            <div class="sum-item"><span class="summary-label">Output VAT</span><span id="outputvat" class="summary-value">0.00</span></div>
          </div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button id="save-dat" class="btn btn-success w-30">Save .DAT</button>
          <button id="convert-xlsx" class="btn btn-warning w-50">Convert â†’ Excel (.xlsx)</button>
        </div>
      </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const tinInput = document.getElementById('client_tin');

            // Fetch client details automatically when TIN is entered
            async function fetchAndFillClient(tin) {
                if (!tin) return;
                const tinNorm = tin.replace(/-/g, '');
                try {
                    const res = await fetch(`/get_client/${tinNorm}`);
                    if (!res.ok) return;
                    const data = await res.json();
                    if (data.found) {
                        document.getElementById('corporate_name').value = data.corporate_name || '';
                        document.getElementById('last_name').value = data.last_name || '';
                        document.getElementById('first_name').value = data.first_name || '';
                        document.getElementById('middle_name').value = data.middle_name || '';
                        document.getElementById('trade_name').value = data.trade_name || '';
                        document.getElementById('address1').value = data.address1 || '';
                        document.getElementById('address2').value = data.address2 || '';
                        document.getElementById('rdo').value = data.rdo || '';
                        document.getElementById('period').focus();
                    }
                } catch (e) {
                    console.log('Client fetch error', e);
                }
            }

            // Auto-format TIN input
            tinInput.addEventListener('blur', () => {
                const val = tinInput.value.trim();
                if (val) fetchAndFillClient(val);
            });

            tinInput.addEventListener('input', () => {
                let value = tinInput.value.replace(/\D/g, '');
                if (value.length > 9) value = value.slice(0, 9);
                let formatted = value;
                if (value.length > 3 && value.length <= 6)
                    formatted = value.slice(0, 3) + '-' + value.slice(3);
                else if (value.length > 6)
                    formatted = value.slice(0, 3) + '-' + value.slice(3, 6) + '-' + value.slice(6);
                tinInput.value = formatted;
            });

            // Auto-format date input
            const periodInput = document.getElementById('period');
            periodInput.addEventListener('input', () => {
                let value = periodInput.value.replace(/\D/g, '');
                if (value.length > 8) value = value.slice(0, 8);
                let formatted = value;
                if (value.length > 4)
                    formatted = value.slice(0, 2) + '/' + value.slice(2, 4) + '/' + value.slice(4);
                else if (value.length > 2)
                    formatted = value.slice(0, 2) + '/' + value.slice(2);
                periodInput.value = formatted;
            });

            // Initialize data
            let rows = [];
            let sums = { exempt: 0, zero: 0, taxable: 0, outputvat: 0 };

            function renderList() {
                const el = document.getElementById('user-list');
                el.innerHTML = rows.map(r => r + '<br>').join('');
                el.contentEditable = true;

                for (const k in sums) {
                    const target = document.getElementById(k);
                    if (target) {
                        const formattedValue = formatNumberWithCommas(sums[k].toFixed(2));
                        target.textContent = formattedValue;
                    }
                }    
            }

            function formatNumberWithCommas(numStr) {
                const parts = numStr.split('.');
                let integerPart = parts[0];
                const decimalPart = parts.length > 1 ? '.' + parts[1] : '.00';

                const isNegative = integerPart.startsWith('-');
                if (isNegative) {
                    integerPart = integerPart.substring(1);
                }

                integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');

                return (isNegative ? '-' : '') + integerPart + decimalPart;
            }

            function resetSums() {
                sums = { exempt: 0, zero: 0, taxable: 0, outputvat: 0 };
            }

            // Submit single entry (manual append)
            document.getElementById('submit-btn').addEventListener('click', async () => {
                const payload = {
                    client_tin: document.getElementById('client_tin').value.replace(/-/g, ''),
                    corporate_name: document.getElementById('corporate_name').value.toUpperCase(),
                    last_name: document.getElementById('last_name').value.toUpperCase(),
                    first_name: document.getElementById('first_name').value.toUpperCase(),
                    middle_name: document.getElementById('middle_name').value.toUpperCase(),
                    trade_name: document.getElementById('trade_name').value.toUpperCase(),
                    address1: document.getElementById('address1').value.toUpperCase(),
                    address2: document.getElementById('address2').value.toUpperCase(),
                    rdo: document.getElementById('rdo').value,
                    period: document.getElementById('period').value
                };
                const res = await fetch('/submit_sales', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (data.row) {
                    const tinNoDashes = payload.client_tin.replace(/-/g, '');
                    rows = rows.map(row => `${row},${tinNoDashes},${payload.period || ''}`);
                    rows.unshift(data.row);
                    renderList();
                } else if (data.error) alert(data.error);
            });

            // Handle CSV upload (now points to /upload_sales)
            document.getElementById('upload-btn').addEventListener('click', () => document.getElementById('csv-input').click());

            document.getElementById('csv-input').addEventListener('change', async (ev) => {
                const file = ev.target.files[0];
                if (!file) return;
                const fd = new FormData();
                fd.append('file', file);

                const res = await fetch('/upload_sales', { method: 'POST', body: fd });
                const data = await res.json();

                document.getElementById('csv-input').value = '';
                if (data.rows) {
                    rows = rows.concat(data.rows);
                    sums = data.sums;
                    renderList();
                } else {
                    alert(data.error || 'Upload failed');
                }
            });

            // Clear list
            document.getElementById('clear-btn').addEventListener('click', () => {
                rows = [];
                resetSums();
                renderList();
            });

            // Save .DAT file
            document.getElementById('save-dat').addEventListener('click', async () => {
                if (rows.length === 0) return alert('No data to save');
                const el = document.getElementById('user-list');
                rows = el.innerText.trim().split('\n').filter(line => line.trim() !== '');

                const res = await fetch('/save_dat_sales', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        rows,
                        client_tin: document.getElementById('client_tin').value.replace(/-/g, ''),
                        period: document.getElementById('period').value
                    })
                });
                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = (await res.headers.get('X-Filename')) || 'output.dat';
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                } else alert('Failed to generate .dat');
            });

            // Convert to Excel (.xlsx)
            document.getElementById('convert-xlsx').addEventListener('click', async () => {
                if (rows.length === 0) return alert('No data to convert');

                // ðŸ©¹ Sync edited text back into the array
                const el = document.getElementById('user-list');
                rows = el.innerText.trim().split('\n').filter(line => line.trim() !== '');

                const res = await fetch('/convert_sales_xlsx', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rows })
                });
                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = (await res.headers.get('X-Filename')) || 'report.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                } else alert('Failed to create Excel');
            });
        });

        // Enable arrow-key navigation between form fields
        window.addEventListener('DOMContentLoaded', () => {
            const inputs = Array.from(document.querySelectorAll('input.form-control'));
            inputs.forEach((input, i) => {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'ArrowDown') { e.preventDefault(); inputs[i + 1]?.focus(); }
                    if (e.key === 'ArrowUp') { e.preventDefault(); inputs[i - 1]?.focus(); }
                });
             });
        });
    </script>
    <script>
      window.addEventListener("load", () => {
        document.body.classList.add("fade-in");
      });

      document.querySelectorAll("a[href]").forEach(link => {
        const url = link.getAttribute("href");
        if (!url.startsWith("#") && !url.startsWith("javascript:")) {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            document.body.classList.remove("fade-in");
            document.body.classList.add("fade-out");
            setTimeout(() => window.location.href = url, 500);
          });
        }
      });
    </script>
  </body>
</html>
