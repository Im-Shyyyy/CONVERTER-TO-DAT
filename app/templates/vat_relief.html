<!-- templates/vat_relief.html -->
{% extends "base.html" %}

{% block title %}VAT Relief - CSV → DAT Converter{% endblock %}

{% block sidebar %}
<div class="sidebar">
  <h4><i class="fas fa-shopping-cart me-2"></i>VAT Relief - Purchases</h4>

  <label class="small-label">Client TIN</label>
  <input id="client_tin" class="form-control mb-2" 
         data-format="tin" data-validate="tin"
         placeholder="XXX-XXX-XXX" maxlength="11" 
         inputmode="numeric" pattern="[0-9\-]*" />

  <label class="small-label">Name & Address</label>
  <input id="corporate_name" class="form-control mb-1" placeholder="Corporate name" />
  <input id="last_name" class="form-control mb-1" placeholder="Last name" />
  <input id="first_name" class="form-control mb-1" placeholder="First name" />
  <input id="middle_name" class="form-control mb-1" placeholder="Middle name" />
  <input id="trade_name" class="form-control mb-1" placeholder="Trade name" />
  <input id="address1" class="form-control mb-1" placeholder="Street, Barangay" />
  <input id="address2" class="form-control mb-1" placeholder="Municipality/City, Zip" />

  <label class="small-label mt-2">RDO</label>
  <input id="rdo" class="form-control mb-2" placeholder="e.g. 001" data-validate="required" />

  <label class="small-label">Period Covered (MM/DD/YYYY)</label>
  <input id="period" class="form-control mb-3" 
         data-format="date" data-validate="date"
         placeholder="mm/dd/yyyy" />

  <div class="spacer"></div>

  <div class="d-grid gap-2 mt-3">
    <button id="submit-btn" class="btn btn-primary">
      <i class="fas fa-plus-circle me-2"></i>Submit (append)
    </button>
    <button id="upload-btn" class="btn btn-outline-light">
      <i class="fas fa-upload me-2"></i>Upload CSV
    </button>
    <input id="csv-input" type="file" accept=".csv" style="display:none" />
    <button id="clear-btn" class="btn btn-danger">
      <i class="fas fa-trash me-2"></i>Clear List
    </button>
  </div>

  <div class="sidebar-buttons d-flex gap-2 mt-3">
    <a href="/dashboard" class="menu-btn">
      <i class="fas fa-bars me-2"></i>Menu
    </a>
    <a href="/logout" class="logout-btn">
      <i class="fas fa-sign-out-alt me-2"></i>Logout
    </a>
  </div>
</div>
{% endblock %}

{% block content %}
<div class="card p-4 flex-grow-1 d-flex flex-column">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h6 class="text-info mb-0">
      <i class="fas fa-eye me-2"></i>Data Preview
    </h6>
    <div class="input-group" style="max-width: 300px;">
      <span class="input-group-text bg-dark border-secondary">
        <i class="fas fa-search"></i>
      </span>
      <input type="text" id="search-input" class="form-control" 
             placeholder="Search in data...">
    </div>
  </div>
  
  <div id="user-list" class="data-preview-container flex-grow-1"></div>

  <div class="sum-box compact mt-3">
    <h6 class="text-info mb-2">
      <i class="fas fa-calculator me-2"></i>Sums
    </h6>
    <div id="sums" class="row row-cols-2 g-1">
      <div class="sum-item"><span class="summary-label">Exempt</span><span id="exempt" class="summary-value">0.00</span></div>
      <div class="sum-item"><span class="summary-label">Zero Rated</span><span id="zero" class="summary-value">0.00</span></div>
      <div class="sum-item"><span class="summary-label">Services</span><span id="serv" class="summary-value">0.00</span></div>
      <div class="sum-item"><span class="summary-label">Capital Goods</span><span id="cap" class="summary-value">0.00</span></div>
      <div class="sum-item"><span class="summary-label">Other Goods</span><span id="other" class="summary-value">0.00</span></div>
      <div class="sum-item"><span class="summary-label">Input Tax</span><span id="inputtax" class="summary-value">0.00</span></div>
    </div>
  </div>

  <div class="d-flex gap-2 mt-3 flex-wrap">
    <button id="save-dat" class="btn btn-success flex-grow-1">
      <i class="fas fa-save me-2"></i>Save .DAT
    </button>
    <button id="convert-xlsx" class="btn btn-warning flex-grow-1">
      <i class="fas fa-file-excel me-2"></i>Convert → Excel
    </button>
    <button id="export-json" class="btn btn-info flex-grow-1">
      <i class="fas fa-download me-2"></i>Export JSON
    </button>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script type="module">
  import { showToast, showProgress, setButtonLoading } from "{{ url_for('static', filename='js/ui-helpers.js') }}";
  import { validateTIN, validateDate } from "{{ url_for('static', filename='js/validators.js') }}";

  // Global data storage
  window.rows = [];
  window.sums = { exempt: 0, zero: 0, serv: 0, cap: 0, other: 0, inputtax: 0 };

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    loadFromLocalStorage();
    setupEventListeners();
    setupSearch();
  });

  function loadFromLocalStorage() {
    const saved = localStorage.getItem('vat_relief_draft');
    if (saved) {
      try {
        const data = JSON.parse(saved);
        window.rows = data.rows || [];
        window.sums = data.sums || window.sums;
        renderList();
        showToast('Draft Loaded', 'Previous data restored from draft', 'info');
      } catch (e) {
        console.error('Failed to load draft:', e);
      }
    }
  }

  function saveToLocalStorage() {
    const data = {
      rows: window.rows,
      sums: window.sums,
      timestamp: new Date().toISOString(),
      client_tin: document.getElementById('client_tin').value
    };
    localStorage.setItem('vat_relief_draft', JSON.stringify(data));
  }

  function setupSearch() {
    const searchInput = document.getElementById('search-input');
    searchInput.addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase();
      const lines = window.rows;
      const preview = document.getElementById('user-list');
      
      preview.innerHTML = lines.map((r, i) => {
        const match = r.toLowerCase().includes(term);
        const display = match ? 
          `<span class="search-highlight">${r}</span>` : r;
        return `${display}<br>`;
      }).join('');
    });
  }

  function setupEventListeners() {
    // Auto-fetch client on TIN blur
    const tinInput = document.getElementById('client_tin');
    tinInput.addEventListener('blur', async () => {
      const val = tinInput.value.trim();
      if (val && validateTIN(val)) {
        await fetchAndFillClient(val);
      }
    });

    // Submit button
    document.getElementById('submit-btn').addEventListener('click', handleSubmit);

    // Upload CSV
    document.getElementById('upload-btn').addEventListener('click', () => {
      document.getElementById('csv-input').click();
    });

    document.getElementById('csv-input').addEventListener('change', handleFileUpload);

    // Clear button
    document.getElementById('clear-btn').addEventListener('click', () => {
      if (window.rows.length > 0) {
        showModal('Clear Data', 'Are you sure you want to clear all data?', [
          { text: 'Cancel', type: 'secondary', action: 'cancel' },
          { text: 'Clear All', type: 'danger', action: 'clear' }
        ]).then(action => {
          if (action === 'clear') {
            window.rows = [];
            resetSums();
            renderList();
            localStorage.removeItem('vat_relief_draft');
            showToast('Cleared', 'All data cleared', 'success');
          }
        });
      }
    });

    // Save .DAT
    document.getElementById('save-dat').addEventListener('click', handleSaveDAT);

    // Convert to Excel
    document.getElementById('convert-xlsx').addEventListener('click', handleConvertExcel);

    // Export JSON
    document.getElementById('export-json').addEventListener('click', handleExportJSON);

    // Auto-save on changes
    const observer = new MutationObserver(() => {
      saveToLocalStorage();
    });
    
    const preview = document.getElementById('user-list');
    observer.observe(preview, { childList: true, subtree: true });
  }

  async function fetchAndFillClient(tin) {
    const hideProgress = showProgress('Fetching client data...');
    try {
      const tinNorm = tin.replace(/-/g, '');
      const res = await fetch(`/get_client/${tinNorm}`);
      if (res.ok) {
        const data = await res.json();
        if (data.found) {
          document.getElementById('corporate_name').value = data.corporate_name || '';
          document.getElementById('last_name').value = data.last_name || '';
          document.getElementById('first_name').value = data.first_name || '';
          document.getElementById('middle_name').value = data.middle_name || '';
          document.getElementById('trade_name').value = data.trade_name || '';
          document.getElementById('address1').value = data.address1 || '';
          document.getElementById('address2').value = data.address2 || '';
          document.getElementById('rdo').value = data.rdo || '';
          document.getElementById('period').focus();
          showToast('Client Found', 'Client details loaded', 'success');
        }
      }
    } catch (e) {
      console.error('Client fetch error:', e);
    } finally {
      hideProgress();
    }
  }

  function renderList() {
    const el = document.getElementById('user-list');
    el.innerHTML = window.rows.map(r => r + '<br>').join('');
    el.contentEditable = true;
    
    // Update sums display
    for (const k in window.sums) {
      const target = document.getElementById(k);
      if (target) target.textContent = window.sums[k].toFixed(2);
    }
  }

  function resetSums() {
    window.sums = { exempt: 0, zero: 0, serv: 0, cap: 0, other: 0, inputtax: 0 };
  }

  async function handleSubmit() {
    const submitBtn = document.getElementById('submit-btn');
    setButtonLoading(submitBtn, true);
    
    try {
      // Validate inputs
      const errors = [];
      if (!validateTIN(document.getElementById('client_tin').value)) {
        errors.push('Valid TIN is required');
      }
      if (!validateDate(document.getElementById('period').value)) {
        errors.push('Valid period date is required');
      }
      
      if (errors.length > 0) {
        showToast('Validation Error', errors.join('<br>'), 'danger');
        return;
      }
      
      const payload = {
        client_tin: document.getElementById('client_tin').value.replace(/-/g, ''),
        corporate_name: document.getElementById('corporate_name').value.toUpperCase(),
        last_name: document.getElementById('last_name').value.toUpperCase(),
        first_name: document.getElementById('first_name').value.toUpperCase(),
        middle_name: document.getElementById('middle_name').value.toUpperCase(),
        trade_name: document.getElementById('trade_name').value.toUpperCase(),
        address1: document.getElementById('address1').value.toUpperCase(),
        address2: document.getElementById('address2').value.toUpperCase(),
        rdo: document.getElementById('rdo').value,
        period: document.getElementById('period').value
      };
      
      const res = await fetch('/submit_entry', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      const data = await res.json();
      if (data.row) {
        const tinNoDashes = payload.client_tin.replace(/-/g, '');
        window.rows = window.rows.map(row => `${row},${tinNoDashes},${payload.period || ''}`);
        window.rows.unshift(data.row);
        renderList();
        showToast('Success', 'Entry added successfully', 'success');
      } else if (data.error) {
        showToast('Error', data.error, 'danger');
      }
    } catch (error) {
      showToast('Error', 'Failed to submit entry', 'danger');
      console.error('Submit error:', error);
    } finally {
      setButtonLoading(submitBtn, false);
    }
  }

  async function handleFileUpload(ev) {
    const file = ev.target.files[0];
    if (!file) return;
    
    const hideProgress = showProgress('Uploading CSV...');
    try {
      const fd = new FormData();
      fd.append('file', file);
      const res = await fetch('/upload_csv', { method: 'POST', body: fd });
      const data = await res.json();
      
      document.getElementById('csv-input').value = '';
      
      if (data.rows) {
        window.rows = window.rows.concat(data.rows);
        window.sums = data.sums;
        renderList();
        showToast('Upload Success', `${data.rows.length} rows processed`, 'success');
      } else {
        showToast('Upload Failed', data.error || 'Upload failed', 'danger');
      }
    } catch (error) {
      showToast('Upload Error', 'Failed to process CSV', 'danger');
      console.error('Upload error:', error);
    } finally {
      hideProgress();
    }
  }

  async function handleSaveDAT() {
    if (window.rows.length === 0) {
      showToast('No Data', 'No data to save', 'warning');
      return;
    }
    
    const hideProgress = showProgress('Generating DAT file...');
    try {
      const el = document.getElementById('user-list');
      window.rows = el.innerText.trim().split('\n').filter(line => line.trim() !== '');
      
      const res = await fetch('/save_dat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          rows: window.rows,
          client_tin: document.getElementById('client_tin').value.replace(/-/g, ''),
          period: document.getElementById('period').value
        })
      });
      
      if (res.ok) {
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = res.headers.get('X-Filename') || 'output.dat';
        document.body.appendChild(a);
        a.click();
        a.remove();
        showToast('Download Started', 'DAT file is being downloaded', 'success');
      } else {
        showToast('Save Failed', 'Failed to generate .dat file', 'danger');
      }
    } catch (error) {
      showToast('Error', 'Failed to save file', 'danger');
      console.error('Save error:', error);
    } finally {
      hideProgress();
    }
  }

  async function handleConvertExcel() {
    if (window.rows.length === 0) {
      showToast('No Data', 'No data to convert', 'warning');
      return;
    }
    
    const hideProgress = showProgress('Generating Excel file...');
    try {
      const el = document.getElementById('user-list');
      window.rows = el.innerText.trim().split('\n').filter(line => line.trim() !== '');
      
      const res = await fetch('/convert_xlsx', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rows: window.rows })
      });
      
      if (res.ok) {
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = res.headers.get('X-Filename') || 'report.xlsx';
        document.body.appendChild(a);
        a.click();
        a.remove();
        showToast('Download Started', 'Excel file is being downloaded', 'success');
      } else {
        showToast('Conversion Failed', 'Failed to create Excel', 'danger');
      }
    } catch (error) {
      showToast('Error', 'Failed to convert to Excel', 'danger');
      console.error('Convert error:', error);
    } finally {
      hideProgress();
    }
  }

  function handleExportJSON() {
    if (window.rows.length === 0) {
      showToast('No Data', 'No data to export', 'warning');
      return;
    }
    
    const data = {
      metadata: {
        client_tin: document.getElementById('client_tin').value,
        period: document.getElementById('period').value,
        generated: new Date().toISOString(),
        type: 'vat_relief_purchases'
      },
      rows: window.rows,
      sums: window.sums,
      totals: {
        exempt: window.sums.exempt,
        zero: window.sums.zero,
        services: window.sums.serv,
        capital_goods: window.sums.cap,
        other_goods: window.sums.other,
        input_tax: window.sums.inputtax
      }
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `vat_relief_${Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    showToast('Export Complete', 'JSON file downloaded', 'success');
  }
</script>
{% endblock %}